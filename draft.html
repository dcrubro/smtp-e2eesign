<!DOCTYPE html>
<html lang="en" class="Internet-Draft">
<head>
<meta charset="utf-8">
<meta content="Common,Latin" name="scripts">
<meta content="initial-scale=1.0" name="viewport">
<title>SMTP Extensions for End-to-End Encryption and User-Level Signatures</title>
<meta content="Jonas Korene Novak" name="author">
<meta content="
       This Internet-Draft proposes adding extensions to the SMTP protocol that allow for true End-to-End Encryption and cryptographic signatures between users on a SMTP server. Current DKIM only allows for server verification, while messages sent through secure channels only encrypt traffic between servers, not between users. 
    " name="description">
<meta content="xml2rfc 3.29.0" name="generator">
<meta content="SMTP" name="keyword">
<meta content="E2EE" name="keyword">
<meta content="cryptographic signature" name="keyword">
<meta content="mail" name="keyword">
<meta content="draft-jonaskorenenovak-smtp-e2eesign-00" name="ietf.draft">
<!-- Generator version information:
  xml2rfc 3.29.0
    Python 3.13.5
    ConfigArgParse 1.7.1
    google-i18n-address 3.1.1
    intervaltree 3.1.0
    Jinja2 3.1.6
    lxml 5.4.0
    platformdirs 4.3.6
    pycountry 24.6.1
    PyYAML 6.0.2
    requests 2.32.4
    setuptools 80.9.0
    wcwidth 0.2.13
    weasyprint 65.0
-->
<link href="draft.xml" rel="alternate" type="application/rfc+xml">
<link href="#copyright" rel="license">
<style type="text/css">/*

  NOTE: Changes at the bottom of this file overrides some earlier settings.

  Once the style has stabilized and has been adopted as an official RFC style,
  this can be consolidated so that style settings occur only in one place, but
  for now the contents of this file consists first of the initial CSS work as
  provided to the RFC Formatter (xml2rfc) work, followed by itemized and
  commented changes found necessary during the development of the v3
  formatters.

*/

/* fonts */
@import url('https://fonts.googleapis.com/css?family=Noto+Sans'); /* Sans-serif */
@import url('https://fonts.googleapis.com/css?family=Noto+Serif'); /* Serif (print) */
@import url('https://fonts.googleapis.com/css?family=Roboto+Mono'); /* Monospace */

:root {
  --font-sans: 'Noto Sans', Arial, Helvetica, sans-serif;
  --font-serif: 'Noto Serif', 'Times', 'Times New Roman', serif;
  --font-mono: 'Roboto Mono', Courier, 'Courier New', monospace;
}

@viewport {
  zoom: 1.0;
}
@-ms-viewport {
  width: extend-to-zoom;
  zoom: 1.0;
}
/* general and mobile first */
html {
}
body {
  max-width: 90%;
  margin: 1.5em auto;
  color: #222;
  background-color: #fff;
  font-size: 14px;
  font-family: var(--font-sans);
  line-height: 1.6;
  scroll-behavior: smooth;
  overflow-wrap: break-word;
}
.ears {
  display: none;
}

/* headings */
#title, h1, h2, h3, h4, h5, h6 {
  margin: 1em 0 0.5em;
  font-weight: bold;
  line-height: 1.3;
}
#title {
  clear: both;
  border-bottom: 1px solid #ddd;
  margin: 0 0 0.5em 0;
  padding: 1em 0 0.5em;
}
.author {
  padding-bottom: 4px;
}
h1 {
  font-size: 26px;
  margin: 1em 0;
}
h2 {
  font-size: 22px;
  margin-top: -20px;  /* provide offset for in-page anchors */
  padding-top: 33px;
}
h3 {
  font-size: 18px;
  margin-top: -36px;  /* provide offset for in-page anchors */
  padding-top: 42px;
}
h4 {
  font-size: 16px;
  margin-top: -36px;  /* provide offset for in-page anchors */
  padding-top: 42px;
}
h5, h6 {
  font-size: 14px;
}
#n-copyright-notice {
  border-bottom: 1px solid #ddd;
  padding-bottom: 1em;
  margin-bottom: 1em;
}
/* general structure */
p {
  padding: 0;
  margin: 0 0 1em 0;
  text-align: left;
}
div, span {
  position: relative;
}
div {
  margin: 0;
}
.alignRight.art-text {
  background-color: #f9f9f9;
  border: 1px solid #eee;
  border-radius: 3px;
  padding: 1em 1em 0;
  margin-bottom: 1.5em;
}
.alignRight.art-text pre {
  padding: 0;
}
.alignRight {
  margin: 1em 0;
}
.alignRight > *:first-child {
  border: none;
  margin: 0;
  float: right;
  clear: both;
}
.alignRight > *:nth-child(2) {
  clear: both;
  display: block;
  border: none;
}
svg {
  display: block;
}
@media print {
  svg {
    max-height: 850px;
    max-width: 660px;
  }
}
svg[font-family~="serif" i], svg [font-family~="serif" i] {
  font-family: var(--font-serif);
}
svg[font-family~="sans-serif" i], svg [font-family~="sans-serif" i] {
  font-family: var(--font-sans);
}
svg[font-family~="monospace" i], svg [font-family~="monospace" i] {
  font-family: var(--font-mono);
}
.alignCenter.art-text {
  background-color: #f9f9f9;
  border: 1px solid #eee;
  border-radius: 3px;
  padding: 1em 1em 0;
  margin-bottom: 1.5em;
}
.alignCenter.art-text pre {
  padding: 0;
}
.alignCenter {
  margin: 1em 0;
}
.alignCenter > *:first-child {
  display: table;
  border: none;
  margin: 0 auto;
}

/* lists */
ol, ul {
  padding: 0;
  margin: 0 0 1em 2em;
}
ol ol, ul ul, ol ul, ul ol {
  margin-left: 1em;
}
li {
  margin: 0 0 0.25em 0;
}
.ulCompact li {
  margin: 0;
}
ul.empty, .ulEmpty {
  list-style-type: none;
}
ul.empty li, .ulEmpty li {
  margin-top: 0.5em;
}
ul.ulBare, li.ulBare {
  margin-left: 0em !important;
}
ul.compact, .ulCompact,
ol.compact, .olCompact {
  line-height: 100%;
  margin: 0 0 0 2em;
}

/* definition lists */
dl {
}
dl > dt {
  float: left;
  margin-right: 1em;
}
/* 
dl.nohang > dt {
  float: none;
}
*/
dl > dd {
  margin-bottom: .8em;
  min-height: 1.3em;
}
dl.compact > dd, .dlCompact > dd {
  margin-bottom: 0em;
}
dl > dd > dl {
  margin-top: 0.5em;
  margin-bottom: 0em;
}

/* links */
a {
  text-decoration: none;
}
a[href] {
  color: #22e; /* Arlen: WCAG 2019 */
}
a[href]:hover {
  background-color: #f2f2f2;
}
figcaption a[href],
a[href].selfRef {
  color: #222;
}
/* XXX probably not this:
a.selfRef:hover {
  background-color: transparent;
  cursor: default;
} */

/* Figures */
tt, code, pre {
  background-color: #f9f9f9;
  font-family: var(--font-mono);
}
pre {
  border: 1px solid #eee;
  margin: 0;
  padding: 1em;
}
img {
  max-width: 100%;
}
figure {
  margin: 0;
}
figure blockquote {
  margin: 0.8em 0.4em 0.4em;
}
figcaption {
  font-style: italic;
  margin: 0 0 1em 0;
}
@media screen {
  pre {
    overflow-x: auto;
    max-width: 100%;
    max-width: calc(100% - 22px);
  }
}

/* aside, blockquote */
aside, blockquote {
  margin-left: 0;
  padding: 1.2em 2em;
}
blockquote {
  background-color: #f9f9f9;
  color: #111; /* Arlen: WCAG 2019 */
  border: 1px solid #ddd;
  border-radius: 3px;
  margin: 1em 0;
}
blockquote > *:last-child {
  margin-bottom: 0;
}
cite {
  display: block;
  text-align: right;
  font-style: italic;
}
.xref {
  overflow-wrap: normal;
}

/* tables */
table {
  width: 100%;
  margin: 0 0 1em;
  border-collapse: collapse;
  border: 1px solid #eee;
}
th, td {
  text-align: left;
  vertical-align: top;
  padding: 0.5em 0.75em;
}
th {
  text-align: left;
  background-color: #e9e9e9;
}
tr:nth-child(2n+1) > td {
  background-color: #f5f5f5;
}
table caption {
  font-style: italic;
  margin: 0;
  padding: 0;
  text-align: left;
}
table p {
  /* XXX to avoid bottom margin on table row signifiers. If paragraphs should
     be allowed within tables more generally, it would be far better to select on a class. */
  margin: 0;
}

/* pilcrow */
a.pilcrow {
  color: #666; /* Arlen: AHDJ 2019 */
  text-decoration: none;
  visibility: hidden;
  user-select: none;
  -ms-user-select: none;
  -o-user-select:none;
  -moz-user-select: none;
  -khtml-user-select: none;
  -webkit-user-select: none;
  -webkit-touch-callout: none;
}
@media screen {
  aside:hover > a.pilcrow,
  p:hover > a.pilcrow,
  blockquote:hover > a.pilcrow,
  div:hover > a.pilcrow,
  li:hover > a.pilcrow,
  pre:hover > a.pilcrow {
    visibility: visible;
  }
  a.pilcrow:hover {
    background-color: transparent;
  }
}

/* misc */
hr {
  border: 0;
  border-top: 1px solid #eee;
}
.bcp14 {
  font-variant: small-caps;
}

.role {
  font-variant: all-small-caps;
}

/* info block */
#identifiers {
  margin: 0;
  font-size: 0.9em;
}
#identifiers dt {
  width: 3em;
  clear: left;
}
#identifiers dd {
  float: left;
  margin-bottom: 0;
}
/* Fix PDF info block run off issue */
@media print {
  #identifiers dd {
    max-width: 100%;
  }
}
#identifiers .authors .author {
  display: inline-block;
  margin-right: 1.5em;
}
#identifiers .authors .org {
  font-style: italic;
}

/* The prepared/rendered info at the very bottom of the page */
.docInfo {
  color: #666; /* Arlen: WCAG 2019 */
  font-size: 0.9em;
  font-style: italic;
  margin-top: 2em;
}
.docInfo .prepared {
  float: left;
}
.docInfo .prepared {
  float: right;
}

/* table of contents */
#toc  {
  padding: 0.75em 0 2em 0;
  margin-bottom: 1em;
}
nav.toc ul {
  margin: 0 0.5em 0 0;
  padding: 0;
  list-style: none;
}
nav.toc li {
  line-height: 1.3em;
  margin: 0.75em 0;
  padding-left: 1.2em;
  text-indent: -1.2em;
}
/* references */
.references dt {
  text-align: right;
  font-weight: bold;
  min-width: 7em;
}
.references dd {
  margin-left: 8em;
  overflow: auto;
}

.refInstance {
  margin-bottom: 1.25em;
}

.refSubseries {
  margin-bottom: 1.25em;
}

.references .ascii {
  margin-bottom: 0.25em;
}

/* index */
.index ul {
  margin: 0 0 0 1em;
  padding: 0;
  list-style: none;
}
.index ul ul {
  margin: 0;
}
.index li {
  margin: 0;
  text-indent: -2em;
  padding-left: 2em;
  padding-bottom: 5px;
}
.indexIndex {
  margin: 0.5em 0 1em;
}
.index a {
  font-weight: 700;
}
/* make the index two-column on all but the smallest screens */
@media (min-width: 600px) {
  .index ul {
    -moz-column-count: 2;
    -moz-column-gap: 20px;
  }
  .index ul ul {
    -moz-column-count: 1;
    -moz-column-gap: 0;
  }
}

/* authors */
address.vcard {
  font-style: normal;
  margin: 1em 0;
}

address.vcard .nameRole {
  font-weight: 700;
  margin-left: 0;
}
address.vcard .label {
  font-family: var(--font-sans);
  margin: 0.5em 0;
}
address.vcard .type {
  display: none;
}
.alternative-contact {
  margin: 1.5em 0 1em;
}
hr.addr {
  border-top: 1px dashed;
  margin: 0;
  color: #ddd;
  max-width: calc(100% - 16px);
}

/* temporary notes */
.rfcEditorRemove::before {
  position: absolute;
  top: 0.2em;
  right: 0.2em;
  padding: 0.2em;
  content: "The RFC Editor will remove this note";
  color: #9e2a00; /* Arlen: WCAG 2019 */
  background-color: #ffd; /* Arlen: WCAG 2019 */
}
.rfcEditorRemove {
  position: relative;
  padding-top: 1.8em;
  background-color: #ffd; /* Arlen: WCAG 2019 */
  border-radius: 3px;
}
.cref {
  background-color: #ffd; /* Arlen: WCAG 2019 */
  padding: 2px 4px;
}
.crefSource {
  font-style: italic;
}
/* alternative layout for smaller screens */
@media screen and (max-width: 1023px) {
  body {
    padding-top: 2em;
  }
  #title {
    padding: 1em 0;
  }
  h1 {
    font-size: 24px;
  }
  h2 {
    font-size: 20px;
    margin-top: -18px;  /* provide offset for in-page anchors */
    padding-top: 38px;
  }
  #identifiers dd {
    max-width: 60%;
  }
  #toc {
    position: fixed;
    z-index: 2;
    top: 0;
    right: 0;
    padding: 0;
    margin: 0;
    background-color: inherit;
    border-bottom: 1px solid #ccc;
  }
  #toc h2 {
    margin: -1px 0 0 0;
    padding: 4px 0 4px 6px;
    padding-right: 1em;
    min-width: 190px;
    font-size: 1.1em;
    text-align: right;
    background-color: #444;
    color: white;
    cursor: pointer;
  }
  #toc h2::before { /* css hamburger */
    float: right;
    position: relative;
    width: 1em;
    height: 1px;
    left: -164px;
    margin: 6px 0 0 0;
    background: white none repeat scroll 0 0;
    box-shadow: 0 4px 0 0 white, 0 8px 0 0 white;
    content: "";
  }
  #toc nav {
    display: none;
    padding: 0.5em 1em 1em;
    overflow: auto;
    height: calc(100vh - 48px);
    border-left: 1px solid #ddd;
  }
}

/* alternative layout for wide screens */
@media screen and (min-width: 1024px) {
  body {
    max-width: 724px;
    margin: 42px auto;
    padding-left: 1.5em;
    padding-right: 29em;
  }
  #toc {
    position: fixed;
    top: 42px;
    right: 42px;
    width: 25%;
    margin: 0;
    padding: 0 1em;
    z-index: 1;
  }
  #toc h2 {
    border-top: none;
    border-bottom: 1px solid #ddd;
    font-size: 1em;
    font-weight: normal;
    margin: 0;
    padding: 0.25em 1em 1em 0;
  }
  #toc nav {
    display: block;
    height: calc(90vh - 84px);
    bottom: 0;
    padding: 0.5em 0 0;
    overflow: auto;
  }
  img { /* future proofing */
    max-width: 100%;
    height: auto;
  }
}

/* pagination */
@media print {
  body {
    width: 100%;
  }
  p {
    orphans: 3;
    widows: 3;
  }
  #n-copyright-notice {
    border-bottom: none;
  }
  #toc, #n-introduction {
    page-break-before: always;
  }
  #toc {
    border-top: none;
    padding-top: 0;
  }
  figure, pre {
    page-break-inside: avoid;
  }
  figure {
    overflow: scroll;
  }
  .breakable pre {
    break-inside: auto;
  }
  h1, h2, h3, h4, h5, h6 {
    page-break-after: avoid;
  }
  h2+*, h3+*, h4+*, h5+*, h6+* {
    page-break-before: avoid;
  }
  pre {
    white-space: pre-wrap;
    word-wrap: break-word;
    font-size: 10pt;
  }
  table {
    border: 1px solid #ddd;
  }
  td {
    border-top: 1px solid #ddd;
  }
}

/* This is commented out here, as the string-set: doesn't
   pass W3C validation currently */
/*
.ears thead .left {
  string-set: ears-top-left content();
}

.ears thead .center {
  string-set: ears-top-center content();
}

.ears thead .right {
  string-set: ears-top-right content();
}

.ears tfoot .left {
  string-set: ears-bottom-left content();
}

.ears tfoot .center {
  string-set: ears-bottom-center content();
}

.ears tfoot .right {
  string-set: ears-bottom-right content();
}
*/

@page :first {
  padding-top: 0;
  @top-left {
    content: normal;
    border: none;
  }
  @top-center {
    content: normal;
    border: none;
  }
  @top-right {
    content: normal;
    border: none;
  }
}

@page {
  size: A4;
  margin-bottom: 45mm;
  padding-top: 20px;
  /* The following is commented out here, but set appropriately by in code, as
     the content depends on the document */
  /*
  @top-left {
    content: 'Internet-Draft';
    vertical-align: bottom;
    border-bottom: solid 1px #ccc;
  }
  @top-left {
    content: string(ears-top-left);
    vertical-align: bottom;
    border-bottom: solid 1px #ccc;
  }
  @top-center {
    content: string(ears-top-center);
    vertical-align: bottom;
    border-bottom: solid 1px #ccc;
  }
  @top-right {
    content: string(ears-top-right);
    vertical-align: bottom;
    border-bottom: solid 1px #ccc;
  }
  @bottom-left {
    content: string(ears-bottom-left);
    vertical-align: top;
    border-top: solid 1px #ccc;
  }
  @bottom-center {
    content: string(ears-bottom-center);
    vertical-align: top;
    border-top: solid 1px #ccc;
  }
  @bottom-right {
      content: '[Page ' counter(page) ']';
      vertical-align: top;
      border-top: solid 1px #ccc;
  }
  */

}

/* Changes introduced to fix issues found during implementation */
/* Make sure links are clickable even if overlapped by following H* */
a {
  z-index: 2;
}
/* Separate body from document info even without intervening H1 */
section {
  clear: both;
}


/* Top align author divs, to avoid names without organization dropping level with org names */
.author {
  vertical-align: top;
}

/* Leave room in document info to show Internet-Draft on one line */
#identifiers dt {
  width: 8em;
}

/* Don't waste quite as much whitespace between label and value in doc info */
#identifiers dd {
  margin-left: 1em;
}

/* Give floating toc a background color (needed when it's a div inside section */
#toc {
  background-color: white;
}

/* Make the collapsed ToC header render white on gray also when it's a link */
@media screen and (max-width: 1023px) {
  #toc h2 a,
  #toc h2 a:link,
  #toc h2 a:focus,
  #toc h2 a:hover,
  #toc a.toplink,
  #toc a.toplink:hover {
    color: white;
    background-color: #444;
    text-decoration: none;
  }
}

/* Give the bottom of the ToC some whitespace */
@media screen and (min-width: 1024px) {
  #toc {
    padding: 0 0 1em 1em;
  }
}

/* Style section numbers with more space between number and title */
.section-number {
  padding-right: 0.5em;
}

/* prevent monospace from becoming overly large */
tt, code, pre {
  font-size: 95%;
}

/* Fix the height/width aspect for ascii art*/
.sourcecode pre,
.art-text pre {
  line-height: 1.12;
}


/* Add styling for a link in the ToC that points to the top of the document */
a.toplink {
  float: right;
  margin-right: 0.5em;
}

/* Fix the dl styling to match the RFC 7992 attributes */
dl > dt,
dl.dlParallel > dt {
  float: left;
  margin-right: 1em;
}
dl.dlNewline > dt {
  float: none;
}

/* Provide styling for table cell text alignment */
table td.text-left,
table th.text-left {
  text-align: left;
}
table td.text-center,
table th.text-center {
  text-align: center;
}
table td.text-right,
table th.text-right {
  text-align: right;
}

/* Make the alternative author contact information look less like just another
   author, and group it closer with the primary author contact information */
.alternative-contact {
  margin: 0.5em 0 0.25em 0;
}
address .non-ascii {
  margin: 0 0 0 2em;
}

/* With it being possible to set tables with alignment
  left, center, and right, { width: 100%; } does not make sense */
table {
  width: auto;
}

/* Avoid reference text that sits in a block with very wide left margin,
   because of a long floating dt label.*/
.references dd {
  overflow: visible;
}

/* Control caption placement */
caption {
  caption-side: bottom;
}

/* Limit the width of the author address vcard, so names in right-to-left
   script don't end up on the other side of the page. */

address.vcard {
  max-width: 30em;
  margin-right: auto;
}

/* For address alignment dependent on LTR or RTL scripts */
address div.left {
  text-align: left;
}
address div.right {
  text-align: right;
}

/* Provide table alignment support.  We can't use the alignX classes above
   since they do unwanted things with caption and other styling. */
table.right {
 margin-left: auto;
 margin-right: 0;
}
table.center {
 margin-left: auto;
 margin-right: auto;
}
table.left {
 margin-left: 0;
 margin-right: auto;
}

/* Give the table caption label the same styling as the figcaption */
caption a[href] {
  color: #222;
}

@media print {
  .toplink {
    display: none;
  }

  /* avoid overwriting the top border line with the ToC header */
  #toc {
    padding-top: 1px;
  }

  /* Avoid page breaks inside dl and author address entries */
  .vcard {
    page-break-inside: avoid;
  }

}
/* Tweak the bcp14 keyword presentation */
.bcp14 {
  font-variant: small-caps;
  font-weight: bold;
  font-size: 0.9em;
}
/* Tweak the invisible space above H* in order not to overlay links in text above */
 h2 {
  margin-top: -18px;  /* provide offset for in-page anchors */
  padding-top: 31px;
 }
 h3 {
  margin-top: -18px;  /* provide offset for in-page anchors */
  padding-top: 24px;
 }
 h4 {
  margin-top: -18px;  /* provide offset for in-page anchors */
  padding-top: 24px;
 }
/* Float artwork pilcrow to the right */
@media screen {
  .artwork a.pilcrow {
    display: block;
    line-height: 0.7;
    margin-top: 0.15em;
  }
}
/* Make pilcrows on dd visible */
@media screen {
  dd:hover > a.pilcrow {
    visibility: visible;
  }
}
/* Make the placement of figcaption match that of a table's caption
   by removing the figure's added bottom margin */
.alignLeft.art-text,
.alignCenter.art-text,
.alignRight.art-text {
   margin-bottom: 0;
}
.alignLeft,
.alignCenter,
.alignRight {
  margin: 1em 0 0 0;
}
/* In print, the pilcrow won't show on hover, so prevent it from taking up space,
   possibly even requiring a new line */
@media print {
  a.pilcrow {
    display: none;
  }
}
/* Styling for the external metadata */
div#external-metadata {
  background-color: #eee;
  padding: 0.5em;
  margin-bottom: 0.5em;
  display: none;
}
div#internal-metadata {
  padding: 0.5em;                       /* to match the external-metadata padding */
}
/* Styling for title RFC Number */
h1#rfcnum {
  clear: both;
  margin: 0 0 -1em;
  padding: 1em 0 0 0;
}
/* Make .olPercent look the same as <ol><li> */
dl.olPercent > dd {
  margin-bottom: 0.25em;
  min-height: initial;
}
/* Give aside some styling to set it apart */
aside {
  border-left: 1px solid #ddd;
  margin: 1em 0 1em 2em;
  padding: 0.2em 2em;
}
aside > dl,
aside > ol,
aside > ul,
aside > table,
aside > p {
  margin-bottom: 0.5em;
}
/* Additional page break settings */
@media print {
  figcaption, table caption {
    page-break-before: avoid;
  }
}
/* Font size adjustments for print */
@media print {
  body  { font-size: 10pt;      line-height: normal; max-width: 96%; }
  h1    { font-size: 1.72em;    padding-top: 1.5em; } /* 1*1.2*1.2*1.2 */
  h2    { font-size: 1.44em;    padding-top: 1.5em; } /* 1*1.2*1.2 */
  h3    { font-size: 1.2em;     padding-top: 1.5em; } /* 1*1.2 */
  h4    { font-size: 1em;       padding-top: 1.5em; }
  h5, h6 { font-size: 1em;      margin: initial; padding: 0.5em 0 0.3em; }
}
/* Sourcecode margin in print, when there's no pilcrow */
@media print {
  .artwork,
  .artwork > pre,
  .sourcecode {
    margin-bottom: 1em;
  }
}
/* Avoid narrow tables forcing too narrow table captions, which may render badly */
table {
  min-width: 20em;
}
/* ol type a */
ol.type-a { list-style-type: lower-alpha; }
ol.type-A { list-style-type: upper-alpha; }
ol.type-i { list-style-type: lower-roman; }
ol.type-I { list-style-type: upper-roman; }
/* Apply the print table and row borders in general, on request from the RPC,
and increase the contrast between border and odd row background slightly */
table {
  border: 1px solid #ddd;
}
td {
  border-top: 1px solid #ddd;
}
tr {
  break-inside: avoid;
}
tr:nth-child(2n+1) > td {
  background-color: #f8f8f8;
}
/* Use style rules to govern display of the TOC. */
@media screen and (max-width: 1023px) {
  #toc nav { display: none; }
  #toc.active nav { display: block; }
}
/* Add support for keepWithNext */
.keepWithNext {
  break-after: avoid-page;
  break-after: avoid-page;
}
/* Add support for keepWithPrevious */
.keepWithPrevious {
  break-before: avoid-page;
}
/* Change the approach to avoiding breaks inside artwork etc. */
figure, pre, table, .artwork, .sourcecode  {
  break-before: auto;
  break-after: auto;
}
/* Avoid breaks between <dt> and <dd> */
dl {
  break-before: auto;
  break-inside: auto;
}
dt {
  break-before: auto;
  break-after: avoid-page;
}
dd {
  break-before: avoid-page;
  break-after: auto;
  orphans: 3;
  widows: 3
}
span.break, dd.break {
  margin-bottom: 0;
  min-height: 0;
  break-before: auto;
  break-inside: auto;
  break-after: auto;
}
/* Undo break-before ToC */
@media print {
  #toc {
    break-before: auto;
  }
}
/* Text in compact lists should not get extra bottom margin space,
   since that would makes the list not compact */
ul.compact p, .ulCompact p,
ol.compact p, .olCompact p {
 margin: 0;
}
/* But the list as a whole needs the extra space at the end */
section ul.compact,
section .ulCompact,
section ol.compact,
section .olCompact {
  margin-bottom: 1em;                    /* same as p not within ul.compact etc. */
}
/* The tt and code background above interferes with for instance table cell
   backgrounds.  Changed to something a bit more selective. */
tt, code {
  background-color: transparent;
}
p tt, p code, li tt, li code, dt tt, dt code {
  background-color: #f8f8f8;
}
/* Tweak the pre margin -- 0px doesn't come out well */
pre {
   margin-top: 0.5px;
}
/* Tweak the compact list text */
ul.compact, .ulCompact,
ol.compact, .olCompact,
dl.compact, .dlCompact {
  line-height: normal;
}
/* Don't add top margin for nested lists */
li > ul, li > ol, li > dl,
dd > ul, dd > ol, dd > dl,
dl > dd > dl {
  margin-top: initial;
}
/* Elements that should not be rendered on the same line as a <dt> */
/* This should match the element list in writer.text.TextWriter.render_dl() */
dd > div.artwork:first-child,
dd > aside:first-child,
dd > figure:first-child,
dd > ol:first-child,
dd > div.sourcecode:first-child,
dd > table:first-child,
dd > ul:first-child {
  clear: left;
}
/* fix for weird browser behaviour when <dd/> is empty */
dt+dd:empty::before{
  content: "\00a0";
}
/* Make paragraph spacing inside <li> smaller than in body text, to fit better within the list */
li > p {
  margin-bottom: 0.5em
}
/* Don't let p margin spill out from inside list items */
li > p:last-of-type:only-child {
  margin-bottom: 0;
}
</style>
<link href="rfc-local.css" rel="stylesheet" type="text/css">
<script type="application/javascript">async function addMetadata(){try{const e=document.styleSheets[0].cssRules;for(let t=0;t<e.length;t++)if(/#identifiers/.exec(e[t].selectorText)){const a=e[t].cssText.replace("#identifiers","#external-updates");document.styleSheets[0].insertRule(a,document.styleSheets[0].cssRules.length)}}catch(e){console.log(e)}const e=document.getElementById("external-metadata");if(e)try{var t,a="",o=function(e){const t=document.getElementsByTagName("meta");for(let a=0;a<t.length;a++)if(t[a].getAttribute("name")===e)return t[a].getAttribute("content");return""}("rfc.number");if(o){t="https://www.rfc-editor.org/rfc/rfc"+o+".json";try{const e=await fetch(t);a=await e.json()}catch(e){t=document.URL.indexOf("html")>=0?document.URL.replace(/html$/,"json"):document.URL+".json";const o=await fetch(t);a=await o.json()}}if(!a)return;e.style.display="block";const s="",d="https://datatracker.ietf.org/doc",n="https://datatracker.ietf.org/ipr/search",c="https://www.rfc-editor.org/info",l=a.doc_id.toLowerCase(),i=a.doc_id.slice(0,3).toLowerCase(),f=a.doc_id.slice(3).replace(/^0+/,""),u={status:"Status",obsoletes:"Obsoletes",obsoleted_by:"Obsoleted By",updates:"Updates",updated_by:"Updated By",see_also:"See Also",errata_url:"Errata"};let h="<dl style='overflow:hidden' id='external-updates'>";["status","obsoletes","obsoleted_by","updates","updated_by","see_also","errata_url"].forEach(e=>{if("status"==e){a[e]=a[e].toLowerCase();var t=a[e].split(" "),o=t.length,w="",p=1;for(let e=0;e<o;e++)p<o?w=w+r(t[e])+" ":w+=r(t[e]),p++;a[e]=w}else if("obsoletes"==e||"obsoleted_by"==e||"updates"==e||"updated_by"==e){var g,m="",b=1;g=a[e].length;for(let t=0;t<g;t++)a[e][t]&&(a[e][t]=String(a[e][t]).toLowerCase(),m=b<g?m+"<a href='"+s+"/rfc/".concat(a[e][t])+"'>"+a[e][t].slice(3)+"</a>, ":m+"<a href='"+s+"/rfc/".concat(a[e][t])+"'>"+a[e][t].slice(3)+"</a>",b++);a[e]=m}else if("see_also"==e){var y,L="",C=1;y=a[e].length;for(let t=0;t<y;t++)if(a[e][t]){a[e][t]=String(a[e][t]);var _=a[e][t].slice(0,3),v=a[e][t].slice(3).replace(/^0+/,"");L=C<y?"RFC"!=_?L+"<a href='"+s+"/info/"+_.toLowerCase().concat(v.toLowerCase())+"'>"+_+" "+v+"</a>, ":L+"<a href='"+s+"/info/"+_.toLowerCase().concat(v.toLowerCase())+"'>"+v+"</a>, ":"RFC"!=_?L+"<a href='"+s+"/info/"+_.toLowerCase().concat(v.toLowerCase())+"'>"+_+" "+v+"</a>":L+"<a href='"+s+"/info/"+_.toLowerCase().concat(v.toLowerCase())+"'>"+v+"</a>",C++}a[e]=L}else if("errata_url"==e){var R="";R=a[e]?R+"<a href='"+a[e]+"'>Errata exist</a> | <a href='"+d+"/"+l+"'>Datatracker</a>| <a href='"+n+"/?"+i+"="+f+"&submit="+i+"'>IPR</a> | <a href='"+c+"/"+l+"'>Info page</a>":"<a href='"+d+"/"+l+"'>Datatracker</a> | <a href='"+n+"/?"+i+"="+f+"&submit="+i+"'>IPR</a> | <a href='"+c+"/"+l+"'>Info page</a>",a[e]=R}""!=a[e]?"Errata"==u[e]?h+=`<dt>More info:</dt><dd>${a[e]}</dd>`:h+=`<dt>${u[e]}:</dt><dd>${a[e]}</dd>`:"Errata"==u[e]&&(h+=`<dt>More info:</dt><dd>${a[e]}</dd>`)}),h+="</dl>",e.innerHTML=h}catch(e){console.log(e)}else console.log("Could not locate metadata <div> element");function r(e){return e.charAt(0).toUpperCase()+e.slice(1)}}window.removeEventListener("load",addMetadata),window.addEventListener("load",addMetadata);</script>
</head>
<body class="xml2rfc">
<script src="metadata.min.js"></script>
<table class="ears">
<thead><tr>
<td class="left">Internet-Draft</td>
<td class="center">SMTP-E2EESIGN</td>
<td class="right">July 2025</td>
</tr></thead>
<tfoot><tr>
<td class="left">Novak</td>
<td class="center">Expires 7 January 2026</td>
<td class="right">[Page]</td>
</tr></tfoot>
</table>
<div id="external-metadata" class="document-information"></div>
<div id="internal-metadata" class="document-information">
<dl id="identifiers">
<dt class="label-workgroup">Workgroup:</dt>
<dd class="workgroup">DISPATCH</dd>
<dt class="label-internet-draft">Internet-Draft:</dt>
<dd class="internet-draft">draft-jonaskorenenovak-smtp-e2eesign-00</dd>
<dt class="label-published">Published:</dt>
<dd class="published">
<time datetime="2025-07-06" class="published">6 July 2025</time>
    </dd>
<dt class="label-intended-status">Intended Status:</dt>
<dd class="intended-status">Informational</dd>
<dt class="label-expires">Expires:</dt>
<dd class="expires"><time datetime="2026-01-07">7 January 2026</time></dd>
<dt class="label-authors">Author:</dt>
<dd class="authors">
<div class="author">
      <div class="author-name">J. K. Novak</div>
<div class="org">Independent</div>
</div>
</dd>
</dl>
</div>
<h1 id="title">SMTP Extensions for End-to-End Encryption and User-Level Signatures</h1>
<section id="section-abstract">
      <h2 id="abstract"><a href="#abstract" class="selfRef">Abstract</a></h2>
<p id="section-abstract-1">This Internet-Draft proposes adding extensions to the SMTP protocol that allow for true End-to-End Encryption and cryptographic signatures between users on a SMTP server. Current DKIM only allows for server verification, while messages sent through secure channels only encrypt traffic between servers, not between users.<a href="#section-abstract-1" class="pilcrow">¶</a></p>
</section>
<section class="note rfcEditorRemove" id="section-note.1">
      <h2 id="name-about-this-document">
<a href="#name-about-this-document" class="section-name selfRef">About This Document</a>
      </h2>
<p id="section-note.1-1">This note is to be removed before publishing as an RFC.<a href="#section-note.1-1" class="pilcrow">¶</a></p>
<p id="section-note.1-2">
        The latest revision of this draft can be found at <span><a href="https://dcrubro.com/files/smtp-ee2esign-latest.html">https://dcrubro.com/files/smtp-ee2esign-latest.html</a></span>.
        Status information for this document may be found at <span><a href="https://datatracker.ietf.org/doc/draft-jonaskorenenovak-smtp-e2eesign/">https://datatracker.ietf.org/doc/draft-jonaskorenenovak-smtp-e2eesign/</a></span>.<a href="#section-note.1-2" class="pilcrow">¶</a></p>
<p id="section-note.1-3">
        Discussion of this document takes place on the
        DISPATCH Working Group mailing list (<span><a href="mailto:dispatch@ietf.org">mailto:dispatch@ietf.org</a></span>),
        which is archived at <span><a href="https://mailarchive.ietf.org/arch/browse/dispatch">https://mailarchive.ietf.org/arch/browse/dispatch</a></span>.
        Subscribe at <span><a href="https://www.ietf.org/mailman/listinfo/dispatch/">https://www.ietf.org/mailman/listinfo/dispatch/</a></span>.<a href="#section-note.1-3" class="pilcrow">¶</a></p>
<p id="section-note.1-4">Source for this draft and an issue tracker can be found at
        <span><a href="https://github.com/dcrubro/smtp-e2eesign">https://github.com/dcrubro/smtp-e2eesign</a></span>.<a href="#section-note.1-4" class="pilcrow">¶</a></p>
</section>
<div id="status-of-memo">
<section id="section-boilerplate.1">
        <h2 id="name-status-of-this-memo">
<a href="#name-status-of-this-memo" class="section-name selfRef">Status of This Memo</a>
        </h2>
<p id="section-boilerplate.1-1">
        This Internet-Draft is submitted in full conformance with the
        provisions of BCP 78 and BCP 79.<a href="#section-boilerplate.1-1" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-2">
        Internet-Drafts are working documents of the Internet Engineering Task
        Force (IETF). Note that other groups may also distribute working
        documents as Internet-Drafts. The list of current Internet-Drafts is
        at <span><a href="https://datatracker.ietf.org/drafts/current/">https://datatracker.ietf.org/drafts/current/</a></span>.<a href="#section-boilerplate.1-2" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-3">
        Internet-Drafts are draft documents valid for a maximum of six months
        and may be updated, replaced, or obsoleted by other documents at any
        time. It is inappropriate to use Internet-Drafts as reference
        material or to cite them other than as "work in progress."<a href="#section-boilerplate.1-3" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-4">
        This Internet-Draft will expire on 7 January 2026.<a href="#section-boilerplate.1-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="copyright">
<section id="section-boilerplate.2">
        <h2 id="name-copyright-notice">
<a href="#name-copyright-notice" class="section-name selfRef">Copyright Notice</a>
        </h2>
<p id="section-boilerplate.2-1">
            Copyright (c) 2025 IETF Trust and the persons identified as the
            document authors. All rights reserved.<a href="#section-boilerplate.2-1" class="pilcrow">¶</a></p>
<p id="section-boilerplate.2-2">
            This document is subject to BCP 78 and the IETF Trust's Legal
            Provisions Relating to IETF Documents
            (<span><a href="https://trustee.ietf.org/license-info">https://trustee.ietf.org/license-info</a></span>) in effect on the date of
            publication of this document. Please review these documents
            carefully, as they describe your rights and restrictions with
            respect to this document.<a href="#section-boilerplate.2-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="toc">
<section id="section-toc.1">
        <a href="#" onclick="scroll(0,0)" class="toplink">▲</a><h2 id="name-table-of-contents">
<a href="#name-table-of-contents" class="section-name selfRef">Table of Contents</a>
        </h2>
<nav class="toc"><ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.1">
            <p id="section-toc.1-1.1.1" class="keepWithNext"><a href="#section-1" class="auto internal xref">1</a>.  <a href="#name-introduction" class="internal xref">Introduction</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.2">
            <p id="section-toc.1-1.2.1" class="keepWithNext"><a href="#section-2" class="auto internal xref">2</a>.  <a href="#name-conventions-and-definitions" class="internal xref">Conventions and Definitions</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3">
            <p id="section-toc.1-1.3.1"><a href="#section-3" class="auto internal xref">3</a>.  <a href="#name-security-considerations" class="internal xref">Security Considerations</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.1">
                <p id="section-toc.1-1.3.2.1.1" class="keepWithNext"><a href="#section-3.1" class="auto internal xref">3.1</a>.  <a href="#name-downgrade-attacks" class="internal xref">Downgrade Attacks</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.2">
                <p id="section-toc.1-1.3.2.2.1"><a href="#section-3.2" class="auto internal xref">3.2</a>.  <a href="#name-channel-security" class="internal xref">Channel Security</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.3">
                <p id="section-toc.1-1.3.2.3.1"><a href="#section-3.3" class="auto internal xref">3.3</a>.  <a href="#name-key-authenticity" class="internal xref">Key Authenticity</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.4">
                <p id="section-toc.1-1.3.2.4.1"><a href="#section-3.4" class="auto internal xref">3.4</a>.  <a href="#name-key-compromise" class="internal xref">Key Compromise</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.5">
                <p id="section-toc.1-1.3.2.5.1"><a href="#section-3.5" class="auto internal xref">3.5</a>.  <a href="#name-hash-function-strength" class="internal xref">Hash Function Strength</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.6">
                <p id="section-toc.1-1.3.2.6.1"><a href="#section-3.6" class="auto internal xref">3.6</a>.  <a href="#name-replay-and-injection" class="internal xref">Replay and Injection</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.7">
                <p id="section-toc.1-1.3.2.7.1"><a href="#section-3.7" class="auto internal xref">3.7</a>.  <a href="#name-metadata-leakage" class="internal xref">Metadata Leakage</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4">
            <p id="section-toc.1-1.4.1"><a href="#section-4" class="auto internal xref">4</a>.  <a href="#name-iana-considerations" class="internal xref">IANA Considerations</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5">
            <p id="section-toc.1-1.5.1"><a href="#section-5" class="auto internal xref">5</a>.  <a href="#name-protocol-extensions" class="internal xref">Protocol Extensions</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6">
            <p id="section-toc.1-1.6.1"><a href="#section-6" class="auto internal xref">6</a>.  <a href="#name-hashing-and-key-derivation-" class="internal xref">Hashing and Key Derivation Algorithms</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.7">
            <p id="section-toc.1-1.7.1"><a href="#section-7" class="auto internal xref">7</a>.  <a href="#name-protocol-definitions" class="internal xref">Protocol Definitions</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.7.2.1">
                <p id="section-toc.1-1.7.2.1.1"><a href="#section-7.1" class="auto internal xref">7.1</a>.  <a href="#name-authentication-method-auth-" class="internal xref">Authentication Method: AUTH HASHEDPASS</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.7.2.2">
                <p id="section-toc.1-1.7.2.2.1"><a href="#section-7.2" class="auto internal xref">7.2</a>.  <a href="#name-message-headers" class="internal xref">Message Headers</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8">
            <p id="section-toc.1-1.8.1"><a href="#section-8" class="auto internal xref">8</a>.  <a href="#name-protocol-process" class="internal xref">Protocol Process</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8.2.1">
                <p id="section-toc.1-1.8.2.1.1"><a href="#section-8.1" class="auto internal xref">8.1</a>.  <a href="#name-message-end-to-end-encrypti" class="internal xref">Message End-to-End Encryption</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8.2.1.2.1">
                    <p id="section-toc.1-1.8.2.1.2.1.1"><a href="#section-8.1.1" class="auto internal xref">8.1.1</a>.  <a href="#name-keypair-generation" class="internal xref">Keypair Generation</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8.2.1.2.2">
                    <p id="section-toc.1-1.8.2.1.2.2.1"><a href="#section-8.1.2" class="auto internal xref">8.1.2</a>.  <a href="#name-encrypting-and-sending-mail" class="internal xref">Encrypting and Sending Mail</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8.2.1.2.3">
                    <p id="section-toc.1-1.8.2.1.2.3.1"><a href="#section-8.1.3" class="auto internal xref">8.1.3</a>.  <a href="#name-reading-mail" class="internal xref">Reading Mail</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8.2.1.2.4">
                    <p id="section-toc.1-1.8.2.1.2.4.1"><a href="#section-8.1.4" class="auto internal xref">8.1.4</a>.  <a href="#name-key-rotation" class="internal xref">Key Rotation</a></p>
</li>
                </ul>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9">
            <p id="section-toc.1-1.9.1"><a href="#section-9" class="auto internal xref">9</a>.  <a href="#name-normative-references" class="internal xref">Normative References</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10">
            <p id="section-toc.1-1.10.1"><a href="#appendix-A" class="auto internal xref"></a><a href="#name-acknowledgments" class="internal xref">Acknowledgments</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.11">
            <p id="section-toc.1-1.11.1"><a href="#appendix-B" class="auto internal xref"></a><a href="#name-authors-address" class="internal xref">Author's Address</a></p>
</li>
        </ul>
</nav>
</section>
</div>
<div id="introduction">
<section id="section-1">
      <h2 id="name-introduction">
<a href="#section-1" class="section-number selfRef">1. </a><a href="#name-introduction" class="section-name selfRef">Introduction</a>
      </h2>
<p id="section-1-1">The current version of SMTP, even with protocols like SMTPS, STARTTLS and DKIM, lacks native support for user-level encryption and cryptographic identity. This document proposes three new SMTP extensions — <code>ENCRYPTMESSAGE</code>,  <code>SIGNMESSAGE</code> and <code>AUTH HASHEDPASS</code> — that allow for end-to-end encrypted content, sender-level digital signatures and hash-based authentication that prevents SMTP servers reconstructing user private keys.<a href="#section-1-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="conventions-and-definitions">
<section id="section-2">
      <h2 id="name-conventions-and-definitions">
<a href="#section-2" class="section-number selfRef">2. </a><a href="#name-conventions-and-definitions" class="section-name selfRef">Conventions and Definitions</a>
      </h2>
<p id="section-2-1">The key words "<span class="bcp14">MUST</span>", "<span class="bcp14">MUST NOT</span>", "<span class="bcp14">REQUIRED</span>", "<span class="bcp14">SHALL</span>", "<span class="bcp14">SHALL NOT</span>", "<span class="bcp14">SHOULD</span>", "<span class="bcp14">SHOULD NOT</span>", "<span class="bcp14">RECOMMENDED</span>", "<span class="bcp14">NOT RECOMMENDED</span>",
"<span class="bcp14">MAY</span>", and "<span class="bcp14">OPTIONAL</span>" in this document are to be interpreted as
described in BCP 14 <span>[<a href="#RFC2119" class="cite xref">RFC2119</a>]</span> <span>[<a href="#RFC8174" class="cite xref">RFC8174</a>]</span> when, and only when, they
appear in all capitals, as shown here.<a href="#section-2-1" class="pilcrow">¶</a></p>
<p id="section-2-2">This document uses the following terms:<a href="#section-2-2" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-2-3.1">
          <p id="section-2-3.1.1"><strong>MUA (Mail User Agent)</strong> and <strong>MTA (Mail Transfer Agent)</strong> as defined in <span>[<a href="#RFC5321" class="cite xref">RFC5321</a>]</span>.<a href="#section-2-3.1.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-2-3.2">
          <p id="section-2-3.2.1"><strong>E2EE</strong>, which stands for <em>End-to-End Encryption</em>.<a href="#section-2-3.2.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-2-3.3">
          <p id="section-2-3.3.1"><strong>Plain-text</strong>, which refers to an unencrypted, human-readable message that can be read by anyone.<a href="#section-2-3.3.1" class="pilcrow">¶</a></p>
</li>
      </ul>
</section>
</div>
<div id="security-considerations">
<section id="section-3">
      <h2 id="name-security-considerations">
<a href="#section-3" class="section-number selfRef">3. </a><a href="#name-security-considerations" class="section-name selfRef">Security Considerations</a>
      </h2>
<p id="section-3-1">This protocol enhances SMTP security by enabling user-level E2EE and cryptographic signatures. However, several risks and considerations apply:<a href="#section-3-1" class="pilcrow">¶</a></p>
<div id="downgrade-attacks">
<section id="section-3.1">
        <h3 id="name-downgrade-attacks">
<a href="#section-3.1" class="section-number selfRef">3.1. </a><a href="#name-downgrade-attacks" class="section-name selfRef">Downgrade Attacks</a>
        </h3>
<p id="section-3.1-1">Clients and servers <span class="bcp14">MUST</span> ensure that use of <code>ENCRYPTMESSAGE</code>, <code>SIGNMESSAGE</code> and <code>AUTH HASHEDPASS</code> is not silently disabled or ignored in transit. SMTP downgrade attacks are a known vector (e.g., STARTTLS stripping).<a href="#section-3.1-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="channel-security">
<section id="section-3.2">
        <h3 id="name-channel-security">
<a href="#section-3.2" class="section-number selfRef">3.2. </a><a href="#name-channel-security" class="section-name selfRef">Channel Security</a>
        </h3>
<p id="section-3.2-1">All authentication commands (e.g., <code>AUTH HASHEDPASS</code>, <code>GETSALT</code>) <span class="bcp14">MUST</span> be used <strong>only over secure channels</strong> such as SMTPS or STARTTLS. Servers <span class="bcp14">MUST</span> reject these commands over plain-text connections (normal SMTP).<a href="#section-3.2-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="key-authenticity">
<section id="section-3.3">
        <h3 id="name-key-authenticity">
<a href="#section-3.3" class="section-number selfRef">3.3. </a><a href="#name-key-authenticity" class="section-name selfRef">Key Authenticity</a>
        </h3>
<p id="section-3.3-1">Clients retrieving public keys via <code>PUBKEY</code> <span class="bcp14">MUST</span> validate that the key is returned from the intended domain. If DNS spoofing or MITM occurs, a forged public key could be inserted.<a href="#section-3.3-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="key-compromise">
<section id="section-3.4">
        <h3 id="name-key-compromise">
<a href="#section-3.4" class="section-number selfRef">3.4. </a><a href="#name-key-compromise" class="section-name selfRef">Key Compromise</a>
        </h3>
<p id="section-3.4-1">If a user's private key is compromised, message confidentiality and authenticity are at risk. Clients <span class="bcp14">SHOULD</span> support key rotation and expiration.<a href="#section-3.4-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="hash-function-strength">
<section id="section-3.5">
        <h3 id="name-hash-function-strength">
<a href="#section-3.5" class="section-number selfRef">3.5. </a><a href="#name-hash-function-strength" class="section-name selfRef">Hash Function Strength</a>
        </h3>
<p id="section-3.5-1">If password-based key derivation is used, the hashing algorithm (Argon2) <span class="bcp14">MUST</span> be strong and salted. SHA-1 and MD5 are not permitted.<a href="#section-3.5-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="replay-and-injection">
<section id="section-3.6">
        <h3 id="name-replay-and-injection">
<a href="#section-3.6" class="section-number selfRef">3.6. </a><a href="#name-replay-and-injection" class="section-name selfRef">Replay and Injection</a>
        </h3>
<p id="section-3.6-1">Signatures must include timestamping or message-ID binding to prevent replay or message tampering. Signatures over headers <span class="bcp14">MUST</span> include all content-critical headers (To, From, Date, Subject).<a href="#section-3.6-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="metadata-leakage">
<section id="section-3.7">
        <h3 id="name-metadata-leakage">
<a href="#section-3.7" class="section-number selfRef">3.7. </a><a href="#name-metadata-leakage" class="section-name selfRef">Metadata Leakage</a>
        </h3>
<p id="section-3.7-1">Message headers like "Subject" may leak information about the message. These <span class="bcp14">SHOULD</span> be encrypted along with the main body of the message to avoid leaking information.<a href="#section-3.7-1" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="iana-considerations">
<section id="section-4">
      <h2 id="name-iana-considerations">
<a href="#section-4" class="section-number selfRef">4. </a><a href="#name-iana-considerations" class="section-name selfRef">IANA Considerations</a>
      </h2>
<p id="section-4-1">This document requests the registration of the following SMTP extension keywords in the "SMTP Service Extensions" registry:<a href="#section-4-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4-2.1">
          <p id="section-4-2.1.1">Keyword: ENCRYPTMESSAGE
Description: Indicates support for user-level message encryption via public key.
Reference: This document<a href="#section-4-2.1.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-4-2.2">
          <p id="section-4-2.2.1">Keyword: SIGNMESSAGE
Description: Indicates support for cryptographic message signatures by end users.
Reference: This document<a href="#section-4-2.2.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-4-2.3">
          <p id="section-4-2.3.1">Keyword: AUTH HASHEDPASS
Description: An SMTP AUTH method that uses hashed password credentials.
Reference: This document<a href="#section-4-2.3.1" class="pilcrow">¶</a></p>
</li>
      </ul>
</section>
</div>
<div id="protocol-extensions">
<section id="section-5">
      <h2 id="name-protocol-extensions">
<a href="#section-5" class="section-number selfRef">5. </a><a href="#name-protocol-extensions" class="section-name selfRef">Protocol Extensions</a>
      </h2>
<p id="section-5-1">Servers that support the extensions defined by this document <span class="bcp14">MUST</span> advertise the <code>ENCRYPTMESSAGE</code>, <code>SIGNMESSAGE</code> and <code>AUTH HASHEDPASS</code> EHLO keywords. These keywords indicate that the server supports the extensions, headers and commands defined by this document.<a href="#section-5-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="hashing-and-key-derivation-algorithms">
<section id="section-6">
      <h2 id="name-hashing-and-key-derivation-">
<a href="#section-6" class="section-number selfRef">6. </a><a href="#name-hashing-and-key-derivation-" class="section-name selfRef">Hashing and Key Derivation Algorithms</a>
      </h2>
<p id="section-6-1">This protocol uses a password-derived key for both authentication (<code>AUTH HASHEDPASS</code>)
and private key generation (via <code>GETSALT</code>).<a href="#section-6-1" class="pilcrow">¶</a></p>
<p id="section-6-2">Servers and clients implementing this protocol:<a href="#section-6-2" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-6-3.1">
          <p id="section-6-3.1.1"><strong><span class="bcp14">MUST</span> support <code>Argon2id</code></strong> with at least 256-bit output and configurable parameters<a href="#section-6-3.1.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-6-3.2">
          <p id="section-6-3.2.1"><strong><span class="bcp14">MUST NOT</span> use PBKDF2, SHA-1, or unsalted hashes</strong><a href="#section-6-3.2.1" class="pilcrow">¶</a></p>
</li>
      </ul>
<p id="section-6-4">Salt values used in this scheme <span class="bcp14">MUST</span> be:
- At least 128 bits
- Unique per user
- Randomly generated at account creation and returned by <code>GETSALT</code><a href="#section-6-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="protocol-definitions">
<section id="section-7">
      <h2 id="name-protocol-definitions">
<a href="#section-7" class="section-number selfRef">7. </a><a href="#name-protocol-definitions" class="section-name selfRef">Protocol Definitions</a>
      </h2>
<p id="section-7-1">This document introduces three new EHLO extensions: <code>ENCRYPTMESSAGE</code>, <code>SIGNMESSAGE</code> and <code>AUTH HASHEDPASS</code>. These keywords advertise the server’s support for end-to-end encryption, user-level message signing and hash-based authentication as defined in this protocol. Clients can use their presence in the EHLO response to determine whether the remote SMTP server supports these features.<a href="#section-7-1" class="pilcrow">¶</a></p>
<p id="section-7-2">This protocol also defines four new SMTP commands: <code>PUBKEY</code>, <code>SETPUBKEY</code>, <code>GETSALT</code> and <code>RSTSALT</code>.<a href="#section-7-2" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-7-3.1">
          <p id="section-7-3.1.1"><strong>The <code>PUBKEY</code> command</strong> retrieves the public key associated with a specific email identity, allowing the sender to encrypt messages for the intended recipient. The key is returned as a base64 encoded string with a prepended algorithm identifier. It <span class="bcp14">SHOULD</span> be issued before <strong>MAIL FROM</strong> and doesn't require authentication.<a href="#section-7-3.1.1" class="pilcrow">¶</a></p>
</li>
      </ul>
<div class="lang-example sourcecode" id="section-7-4">
<pre>
C: PUBKEY alice@example.com
S: 220 ed25519 QUFBQUMzTnphQzFsWkR...
</pre><a href="#section-7-4" class="pilcrow">¶</a>
</div>
<ul class="normal">
<li class="normal" id="section-7-5.1">
          <p id="section-7-5.1.1">For an unknown user:<a href="#section-7-5.1.1" class="pilcrow">¶</a></p>
</li>
      </ul>
<div class="lang-example sourcecode" id="section-7-6">
<pre>
C: PUBKEY bob@example.net
S: 550 No public key available for bob@example.net
</pre><a href="#section-7-6" class="pilcrow">¶</a>
</div>
<ul class="normal">
<li class="normal" id="section-7-7.1">
          <p id="section-7-7.1.1"><strong>The <code>SETPUBKEY</code> command</strong> requests the server to set the server-stored public key for the authenticated user to the requested value. This command can be used to modify the public key in case of a password or salt change. It <span class="bcp14">SHOULD</span> be issued before <strong>MAIL FROM</strong> and requires authentication.<a href="#section-7-7.1.1" class="pilcrow">¶</a></p>
</li>
      </ul>
<div class="lang-example sourcecode" id="section-7-8">
<pre>
C: SETPUBKEY base64(publickey)
S: 250 OK
</pre><a href="#section-7-8" class="pilcrow">¶</a>
</div>
<ul class="normal">
<li class="normal" id="section-7-9.1">
          <p id="section-7-9.1.1">For an unauthenticated session:<a href="#section-7-9.1.1" class="pilcrow">¶</a></p>
</li>
      </ul>
<div class="lang-example sourcecode" id="section-7-10">
<pre>
C: SETPUBKEY base64(publickey)
S: 530 5.7.0 Authentication required
</pre><a href="#section-7-10" class="pilcrow">¶</a>
</div>
<ul class="normal">
<li class="normal" id="section-7-11.1">
          <p id="section-7-11.1.1"><strong>The <code>GETSALT</code> command</strong> retrieves the password-derived salt associated with the authenticated user in the current session. This command is available only after successful authentication using the <code>AUTH HASHEDPASS</code> mechanism. The salt is returned as a base64 encoded string. It <span class="bcp14">SHOULD</span> be issued before <strong>MAIL FROM</strong> and requires authentication.<a href="#section-7-11.1.1" class="pilcrow">¶</a></p>
</li>
      </ul>
<div class="lang-example sourcecode" id="section-7-12">
<pre>
C: GETSALT
S: 220 SALT ODcyZmQwNTFlOTM4OTFh...
</pre><a href="#section-7-12" class="pilcrow">¶</a>
</div>
<ul class="normal">
<li class="normal" id="section-7-13.1">
          <p id="section-7-13.1.1">For an unauthenticated session:<a href="#section-7-13.1.1" class="pilcrow">¶</a></p>
</li>
      </ul>
<div class="lang-example sourcecode" id="section-7-14">
<pre>
C: GETSALT
S: 530 5.7.0 Authentication required
</pre><a href="#section-7-14" class="pilcrow">¶</a>
</div>
<ul class="normal">
<li class="normal" id="section-7-15.1">
          <p id="section-7-15.1.1"><strong>The <code>RSTSALT</code> command</strong> requests the server to reset the server-stored salt for the authenticated user to a new, random (128 bits is sufficient) value, and returns it to the client as a base64 encoded string. It <span class="bcp14">SHOULD</span> be issued before <strong>MAIL FROM</strong> and requires authentication.<a href="#section-7-15.1.1" class="pilcrow">¶</a></p>
</li>
      </ul>
<div class="lang-example sourcecode" id="section-7-16">
<pre>
C: RSTSALT
S: 220 SALT MDk5YTE4ZmJjODlhMTg4...
</pre><a href="#section-7-16" class="pilcrow">¶</a>
</div>
<ul class="normal">
<li class="normal" id="section-7-17.1">
          <p id="section-7-17.1.1">For an unauthenticated session:<a href="#section-7-17.1.1" class="pilcrow">¶</a></p>
</li>
      </ul>
<div class="lang-example sourcecode" id="section-7-18">
<pre>
C: RSTSALT
S: 530 5.7.0 Authentication required
</pre><a href="#section-7-18" class="pilcrow">¶</a>
</div>
<div id="authentication-method-auth-hashedpass">
<section id="section-7.1">
        <h3 id="name-authentication-method-auth-">
<a href="#section-7.1" class="section-number selfRef">7.1. </a><a href="#name-authentication-method-auth-" class="section-name selfRef">Authentication Method: AUTH HASHEDPASS</a>
        </h3>
<p id="section-7.1-1">This protocol defines a new authentication mechanism: <code>AUTH HASHEDPASS</code>. This mechanism is intended for use only over secure channels, such as SMTP with STARTTLS or SMTPS (port 465). Servers <span class="bcp14">MUST NOT</span> advertise or accept <code>AUTH HASHEDPASS</code> over unencrypted connections.<a href="#section-7.1-1" class="pilcrow">¶</a></p>
<p id="section-7.1-2">Unlike <code>AUTH PLAIN</code>, which transmits the user's cleartext password (typically as a base64-encoded <code>\0username\0password</code> string), <code>AUTH HASHEDPASS</code> transmits a cryptographic hash of that string instead.<a href="#section-7.1-2" class="pilcrow">¶</a></p>
<p id="section-7.1-3">The client computes the hash of the <code>\0username\0password</code> string using a secure, salted <strong>Argon2</strong> hashing function. The result is then sent to the server:<a href="#section-7.1-3" class="pilcrow">¶</a></p>
<div class="lang-example sourcecode" id="section-7.1-4">
<pre>
C: AUTH HASHEDPASS base64(\0username\0hash(password))
S: 235 Authentication successful
</pre><a href="#section-7.1-4" class="pilcrow">¶</a>
</div>
<p id="section-7.1-5">The server compares the received hash to a verifier stored at account creation. This allows the server to authenticate the client <strong>without ever seeing or storing the original password</strong>.<a href="#section-7.1-5" class="pilcrow">¶</a></p>
<p id="section-7.1-6">Because the hash is static and reusable, this authentication mechanism <span class="bcp14">MUST</span> be used only over a secure channel (e.g., TLS). This protects the hash from replay or offline brute-force attacks.<a href="#section-7.1-6" class="pilcrow">¶</a></p>
</section>
</div>
<div id="message-headers">
<section id="section-7.2">
        <h3 id="name-message-headers">
<a href="#section-7.2" class="section-number selfRef">7.2. </a><a href="#name-message-headers" class="section-name selfRef">Message Headers</a>
        </h3>
<p id="section-7.2-1">This protocol defines a couple headers that can be added to a message to identify the sender and the mail.<a href="#section-7.2-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-7.2-2.1">
            <p id="section-7.2-2.1.1"><code>X-Sender-Encrypted</code>: This header should be added to a message if its contents are encrypted in compliance with this protocol. If it's missing or set to "no", the message is considered plain-text.<a href="#section-7.2-2.1.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<div class="lang-example sourcecode" id="section-7.2-3">
<pre>
X-Sender-Encrypted: yes
</pre><a href="#section-7.2-3" class="pilcrow">¶</a>
</div>
<ul class="normal">
<li class="normal" id="section-7.2-4.1">
            <p id="section-7.2-4.1.1"><code>X-Sender-Pubkey</code>: This header is a courtesy header that includes the sender's public key as a raw UTF-8 string with a prepended algorithm identifier.<a href="#section-7.2-4.1.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<div class="lang-example sourcecode" id="section-7.2-5">
<pre>
X-Sender-Pubkey: ed25519 AAAAC3NzaC1lZDI1NTE5AAA...
</pre><a href="#section-7.2-5" class="pilcrow">¶</a>
</div>
<ul class="normal">
<li class="normal" id="section-7.2-6.1">
            <p id="section-7.2-6.1.1"><code>X-Sender-Signature</code>: This header is a courtesy header that includes the sender's public key as a raw UTF-8 string with a prepended algorithm identifier. This signature is derived from the raw (byte-for-byte) message contents (after headers), and the optional headers <code>From</code>, <code>To</code>, <code>Date</code>, <code>Subject</code> and <code>Message-ID</code> (if they're present). This signature can be verified by issuing a <code>PUBKEY</code> command to the sender server for the sender email address and verifing the signature against the encrypted source data and the retrieved public key. This header <strong><span class="bcp14">MUST</span> not be trusted</strong> and <strong><span class="bcp14">MUST</span> be validated via PUBKEY</strong> to avoid security pitfalls.<a href="#section-7.2-6.1.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<div class="lang-example sourcecode" id="section-7.2-7">
<pre>
X-Sender-Signature: ed25519 d75a980182b10ab7d54b...
</pre><a href="#section-7.2-7" class="pilcrow">¶</a>
</div>
</section>
</div>
</section>
</div>
<div id="protocol-process">
<section id="section-8">
      <h2 id="name-protocol-process">
<a href="#section-8" class="section-number selfRef">8. </a><a href="#name-protocol-process" class="section-name selfRef">Protocol Process</a>
      </h2>
<p id="section-8-1">This protocol defines a simple process to exchange encrypted and/or signed mail.<a href="#section-8-1" class="pilcrow">¶</a></p>
<div id="message-end-to-end-encryption">
<section id="section-8.1">
        <h3 id="name-message-end-to-end-encrypti">
<a href="#section-8.1" class="section-number selfRef">8.1. </a><a href="#name-message-end-to-end-encrypti" class="section-name selfRef">Message End-to-End Encryption</a>
        </h3>
<p id="section-8.1-1">To provide true E2EE to users, a few conditions must be met.<a href="#section-8.1-1" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-8.1-2">
<li id="section-8.1-2.1">
            <p id="section-8.1-2.1.1">The plain-text (unencrypted) mail should only be available to the sender user and the receiver user, with no middle party being able to access it.<a href="#section-8.1-2.1.1" class="pilcrow">¶</a></p>
</li>
          <li id="section-8.1-2.2">
            <p id="section-8.1-2.2.1">The decryption (private) key should only be accessible to the user which receives the encrypted mail.<a href="#section-8.1-2.2.1" class="pilcrow">¶</a></p>
</li>
        </ol>
<p id="section-8.1-3">By protocol design, each user should have their own public/private keypair, which can be generated via a preferred asymmetric encryption algorithm (e.g. RSA or ED25519).<a href="#section-8.1-3" class="pilcrow">¶</a></p>
<p id="section-8.1-4">Each user's public key <span class="bcp14">SHOULD</span> be stored by the SMTP server responsible for handling mail for their domain (e.g., the server handling <code>example.com</code> stores public keys for users like <code>user@example.com</code>). These public keys enable senders to encrypt messages such that only the intended recipient — the holder of the corresponding private key — can decrypt them.<a href="#section-8.1-4" class="pilcrow">¶</a></p>
<p id="section-8.1-5">The private key — which can be used for decrypting messages that have been encrypted by its corresponding public key — <span class="bcp14">SHOULD</span> only be held by the actual user. No copy of it should exist on the SMTP server or any other place.<a href="#section-8.1-5" class="pilcrow">¶</a></p>
<div id="keypair-generation">
<section id="section-8.1.1">
          <h4 id="name-keypair-generation">
<a href="#section-8.1.1" class="section-number selfRef">8.1.1. </a><a href="#name-keypair-generation" class="section-name selfRef">Keypair Generation</a>
          </h4>
<p id="section-8.1.1-1">Generating a keypair poses a problem. Logically, we could just generate a random keypair, store the public key on the SMTP server and keep the private key for ourselves, however this gives users a new responsibility of keeping another secret besides their authentication password.<a href="#section-8.1.1-1" class="pilcrow">¶</a></p>
<p id="section-8.1.1-2">The ideal scenario should be to use the user's password to derive the private key (and subsequently the public key). However, users cannot realistically be trusted to create secure and random passwords to generate a secure keypair.<a href="#section-8.1.1-2" class="pilcrow">¶</a></p>
<p id="section-8.1.1-3">Instead, this document proposes the solution of using a random salt, stored by the server. To put this sequence into a proper flow:<a href="#section-8.1.1-3" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-8.1.1-4">
<li id="section-8.1.1-4.1">
              <p id="section-8.1.1-4.1.1">When the user authenticates with the SMTP server, the server checks its local salt store.<a href="#section-8.1.1-4.1.1" class="pilcrow">¶</a></p>
</li>
            <li id="section-8.1.1-4.2">
              <p id="section-8.1.1-4.2.1">If no salt is found, one is randomly generated (128 bits is sufficient) and stored by the server.<a href="#section-8.1.1-4.2.1" class="pilcrow">¶</a></p>
</li>
            <li id="section-8.1.1-4.3">
              <p id="section-8.1.1-4.3.1">The server responds to the client (user) with the base64 encoded salt, e.g.:<a href="#section-8.1.1-4.3.1" class="pilcrow">¶</a></p>
<div class="lang-example sourcecode" id="section-8.1.1-4.3.2">
<pre>
C: AUTH HASHEDPASS base64(\0username\0hash(password))
S: 235 Authentication successful
S: 250 SALT &lt;base64-salt&gt;
</pre><a href="#section-8.1.1-4.3.2" class="pilcrow">¶</a>
</div>
</li>
            <li id="section-8.1.1-4.4">
              <p id="section-8.1.1-4.4.1">With the gotten salt, the user derives a private key for the desired algorithm using a function <code>KDF</code> by passing it the arguments as such: <code>KDF(password, salt)</code><a href="#section-8.1.1-4.4.1" class="pilcrow">¶</a></p>
</li>
            <li id="section-8.1.1-4.5">
              <p id="section-8.1.1-4.5.1">The user (still in the authenticated session) sets its public key on the SMTP server by using the <code>SETPUBKEY</code> command as described in the "Protocol Definitions" section:<a href="#section-8.1.1-4.5.1" class="pilcrow">¶</a></p>
<div class="lang-example sourcecode" id="section-8.1.1-4.5.2">
<pre>
C: SETPUBKEY base64(publickey)
S: 250 OK
</pre><a href="#section-8.1.1-4.5.2" class="pilcrow">¶</a>
</div>
</li>
          </ol>
<p id="section-8.1.1-5">By using this method, the user and server now have their required data, without leaking any sensitive info. Since the salt is a big part of the private key, but still not sufficient to generate it, this effectively makes the private key only generatable by the user that knows the password. Of course, making the password itself longer and more random helps a lot to making the private key even more unguessable.<a href="#section-8.1.1-5" class="pilcrow">¶</a></p>
</section>
</div>
<div id="encrypting-and-sending-mail">
<section id="section-8.1.2">
          <h4 id="name-encrypting-and-sending-mail">
<a href="#section-8.1.2" class="section-number selfRef">8.1.2. </a><a href="#name-encrypting-and-sending-mail" class="section-name selfRef">Encrypting and Sending Mail</a>
          </h4>
<p id="section-8.1.2-1">Encrypting mail and sending it to the receiver is fairly straightforward. We can use this flow to securely send mail to the receiver without any intermediate party being able to read it:<a href="#section-8.1.2-1" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-8.1.2-2">
<li id="section-8.1.2-2.1">
              <p id="section-8.1.2-2.1.1">The sender (locally) writes out the e-mail with their desired content.<a href="#section-8.1.2-2.1.1" class="pilcrow">¶</a></p>
</li>
            <li id="section-8.1.2-2.2">
              <p id="section-8.1.2-2.2.1">The sender (e.g. at the "example.net" domain) connects to the receiver's domain's SMTP server and issues an <code>EHLO</code>. If the EHLO responds with the <code>ENCRYPTMESSAGE</code> and <code>SIGNMESSAGE</code> extensions, we can continue with encryption.<a href="#section-8.1.2-2.2.1" class="pilcrow">¶</a></p>
<div class="lang-example sourcecode" id="section-8.1.2-2.2.2">
<pre>
C: EHLO example.net
S: 250-example.com
S: ...
S: 250-ENCRYPTMESSAGE
S: 250-SIGNMESSAGE
S: 250-AUTH HASHEDPASS
</pre><a href="#section-8.1.2-2.2.2" class="pilcrow">¶</a>
</div>
</li>
            <li id="section-8.1.2-2.3">
              <p id="section-8.1.2-2.3.1">The sender issues the <code>PUBKEY</code> command for the receiver. If the SMTP server responds with <strong>220</strong>, the receiver has a public key on the server, which we can temporarily store. Else, if the server responds with <strong>550</strong> (the SMTP server does not have a public key for that user), we can fallback to sending normal, plain-text mail.<a href="#section-8.1.2-2.3.1" class="pilcrow">¶</a></p>
<div class="lang-example sourcecode" id="section-8.1.2-2.3.2">
<pre>
C: PUBKEY receiver@example.com
S: 220 ed25519 QUFBQUMzTnphQzFsWkR...
</pre><a href="#section-8.1.2-2.3.2" class="pilcrow">¶</a>
</div>
</li>
            <li id="section-8.1.2-2.4">
              <p id="section-8.1.2-2.4.1">With this public key, we can proceed to encrypt the parts of the mail that we want to secure in <strong>DATA</strong> (e.g. the "Subject" header, the message body, attachments, etc.). We also add the <code>X-Sender-Encrypted: yes</code> header to inform the receiver that the message is encrypted. The message <span class="bcp14">MUST</span> be ASCII-armored to ensure best compatability with SMTP (in base64 format).<a href="#section-8.1.2-2.4.1" class="pilcrow">¶</a></p>
</li>
            <li id="section-8.1.2-2.5">
              <p id="section-8.1.2-2.5.1">If the receiver SMTP server provides <code>SIGNMESSAGE</code> in its <code>EHLO</code>, we can proceed to sign the message. In the signature function, we can sign the agreed-upon, encrypted parts of the message (e.g. the "Subject" header, the "Date" header (or UNIX timestamp), the "From" header, the "To" header, the message body, etc.). We then append the signature to the mail in the <code>X-Sender-Signature</code> header.<a href="#section-8.1.2-2.5.1" class="pilcrow">¶</a></p>
</li>
            <li id="section-8.1.2-2.6">
              <p id="section-8.1.2-2.6.1">Optionally, we can also provide our public key in the <code>X-Sender-Pubkey</code> header. This is optional, because a receiver <span class="bcp14">SHOULD</span> issue their own <code>PUBKEY</code> request to the sender's SMTP server instead of trusting the provided one.<a href="#section-8.1.2-2.6.1" class="pilcrow">¶</a></p>
</li>
            <li id="section-8.1.2-2.7">
              <p id="section-8.1.2-2.7.1">We can now submit the mail to the receiver's SMTP server normally, using the encrypted content instead.<a href="#section-8.1.2-2.7.1" class="pilcrow">¶</a></p>
</li>
          </ol>
<p id="section-8.1.2-3">The whole flow in a SMTP session should look something like this:<a href="#section-8.1.2-3" class="pilcrow">¶</a></p>
<p id="section-8.1.2-4">User/Client side:<a href="#section-8.1.2-4" class="pilcrow">¶</a></p>
<div class="lang-example sourcecode" id="section-8.1.2-5">
<pre>
C: EHLO example.net
S: 250-example.com
S: ...
S: 250-ENCRYPTMESSAGE
S: 250-SIGNMESSAGE
S: 250-AUTH HASHEDPASS

C: PUBKEY receiver@example.com
S: 220 ed25519 QUFBQUMzTnphQzFsWkR...

C: QUIT
S: 221 2.0.0 Bye
</pre><a href="#section-8.1.2-5" class="pilcrow">¶</a>
</div>
<p id="section-8.1.2-6">Sender SMTP server side:<a href="#section-8.1.2-6" class="pilcrow">¶</a></p>
<div class="lang-example sourcecode" id="section-8.1.2-7">
<pre>
C: EHLO example.net
S: 250-example.com
S: ...
S: 250-ENCRYPTMESSAGE
S: 250-SIGNMESSAGE

C: MAIL FROM:&lt;sender@example.net&gt;
S: 250 2.1.0 OK
C: RCPT TO:&lt;receiver@example.com&gt;
S: 250 2.1.0 OK

C: DATA
S: 354 End data with &lt;CR&gt;&lt;LF&gt;.&lt;CR&gt;&lt;LF&gt;

Headers and encrypted message data here

C: &lt;CR&gt;&lt;LF&gt;.&lt;CR&gt;&lt;LF&gt;
S: 250 OK: queued as 12345

C: QUIT
S: 221 2.0.0 Bye
</pre><a href="#section-8.1.2-7" class="pilcrow">¶</a>
</div>
</section>
</div>
<div id="reading-mail">
<section id="section-8.1.3">
          <h4 id="name-reading-mail">
<a href="#section-8.1.3" class="section-number selfRef">8.1.3. </a><a href="#name-reading-mail" class="section-name selfRef">Reading Mail</a>
          </h4>
<p id="section-8.1.3-1">When a receiver wants to read their mail, they can do so like this:<a href="#section-8.1.3-1" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-8.1.3-2">
<li id="section-8.1.3-2.1">
              <p id="section-8.1.3-2.1.1">Authenticate into their SMTP server (e.g. using <code>AUTH HASHEDPASS</code>) as described above.<a href="#section-8.1.3-2.1.1" class="pilcrow">¶</a></p>
</li>
            <li id="section-8.1.3-2.2">
              <p id="section-8.1.3-2.2.1">Request their own <strong>SALT</strong> by issuing a <code>GETSALT</code> command.<a href="#section-8.1.3-2.2.1" class="pilcrow">¶</a></p>
</li>
            <li id="section-8.1.3-2.3">
              <p id="section-8.1.3-2.3.1">Rederive their private key from their password and received salt.<a href="#section-8.1.3-2.3.1" class="pilcrow">¶</a></p>
</li>
            <li id="section-8.1.3-2.4">
              <p id="section-8.1.3-2.4.1">Use a mail retrieval protocol like <strong>IMAP</strong> or <strong>POP3</strong> and decrypt/verify the mail locally using their private key and the sender's public key (gotten by issuing a <code>PUBKEY &lt;sender email&gt;</code> to the sender's SMTP server).<a href="#section-8.1.3-2.4.1" class="pilcrow">¶</a></p>
</li>
          </ol>
</section>
</div>
<div id="key-rotation">
<section id="section-8.1.4">
          <h4 id="name-key-rotation">
<a href="#section-8.1.4" class="section-number selfRef">8.1.4. </a><a href="#name-key-rotation" class="section-name selfRef">Key Rotation</a>
          </h4>
<p id="section-8.1.4-1">Users <span class="bcp14">MAY</span> want to occasionally rotate their keypairs to secure their mail. This can be done with the following flow:<a href="#section-8.1.4-1" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-8.1.4-2">
<li id="section-8.1.4-2.1">
              <p id="section-8.1.4-2.1.1">Authenticate into their SMTP server (e.g. using <code>AUTH HASHEDPASS</code>) as described above.<a href="#section-8.1.4-2.1.1" class="pilcrow">¶</a></p>
</li>
            <li id="section-8.1.4-2.2">
              <p id="section-8.1.4-2.2.1">Requesting a new <strong>SALT</strong> by issuing a <code>RSTSALT</code> command.<a href="#section-8.1.4-2.2.1" class="pilcrow">¶</a></p>
</li>
            <li id="section-8.1.4-2.3">
              <p id="section-8.1.4-2.3.1">Derive a new private key from their password and received salt.<a href="#section-8.1.4-2.3.1" class="pilcrow">¶</a></p>
</li>
            <li id="section-8.1.4-2.4">
              <p id="section-8.1.4-2.4.1">Issue the new public key (derived from the private key) to the SMTP server by issuing a <code>SETPUBKEY</code> command to it.<a href="#section-8.1.4-2.4.1" class="pilcrow">¶</a></p>
</li>
            <li id="section-8.1.4-2.5">
              <p id="section-8.1.4-2.5.1">The old private key <span class="bcp14">MAY</span> be saved locally to keep access to old mail.<a href="#section-8.1.4-2.5.1" class="pilcrow">¶</a></p>
</li>
          </ol>
</section>
</div>
</section>
</div>
</section>
</div>
<div id="sec-normative-references">
<section id="section-9">
      <h2 id="name-normative-references">
<a href="#section-9" class="section-number selfRef">9. </a><a href="#name-normative-references" class="section-name selfRef">Normative References</a>
      </h2>
<dl class="references">
<dt id="RFC2119">[RFC2119]</dt>
      <dd>
<span class="refAuthor">Bradner, S.</span>, <span class="refTitle">"Key words for use in RFCs to Indicate Requirement Levels"</span>, <span class="seriesInfo">BCP 14</span>, <span class="seriesInfo">RFC 2119</span>, <span class="seriesInfo">DOI 10.17487/RFC2119</span>, <time datetime="1997-03" class="refDate">March 1997</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc2119">https://www.rfc-editor.org/rfc/rfc2119</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC5321">[RFC5321]</dt>
      <dd>
<span class="refAuthor">Klensin, J.</span>, <span class="refTitle">"Simple Mail Transfer Protocol"</span>, <span class="seriesInfo">RFC 5321</span>, <span class="seriesInfo">DOI 10.17487/RFC5321</span>, <time datetime="2008-10" class="refDate">October 2008</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc5321">https://www.rfc-editor.org/rfc/rfc5321</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8174">[RFC8174]</dt>
    <dd>
<span class="refAuthor">Leiba, B.</span>, <span class="refTitle">"Ambiguity of Uppercase vs Lowercase in RFC 2119 Key Words"</span>, <span class="seriesInfo">BCP 14</span>, <span class="seriesInfo">RFC 8174</span>, <span class="seriesInfo">DOI 10.17487/RFC8174</span>, <time datetime="2017-05" class="refDate">May 2017</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc8174">https://www.rfc-editor.org/rfc/rfc8174</a>&gt;</span>. </dd>
<dd class="break"></dd>
</dl>
</section>
</div>
<div id="acknowledgments">
<section id="appendix-A">
      <h2 id="name-acknowledgments">
<a href="#name-acknowledgments" class="section-name selfRef">Acknowledgments</a>
      </h2>
<p id="appendix-A-1">Thanks to the email security community for inspiration, guidance, and decades of pain to learn from.<a href="#appendix-A-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="authors-addresses">
<section id="appendix-B">
      <h2 id="name-authors-address">
<a href="#name-authors-address" class="section-name selfRef">Author's Address</a>
      </h2>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Jonas Korene Novak</span></div>
<div dir="auto" class="left"><span class="org">Independent</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:info@dcrubro.com" class="email">info@dcrubro.com</a>
</div>
</address>
</section>
</div>
<script>const toc = document.getElementById("toc");
toc.querySelector("h2").addEventListener("click", e => {
  toc.classList.toggle("active");
});
toc.querySelector("nav").addEventListener("click", e => {
  toc.classList.remove("active");
});
</script>
</body>
</html>
